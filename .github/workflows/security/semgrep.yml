name: Semgrep Security Scan
on:
  push: { branches: [main] }
  pull_request:
  schedule: [{ cron: "0 9 * * 1" }]
  workflow_dispatch:

jobs:
  semgrep:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
      pull-requests: write
      checks: write
    container:
      # Pin to a specific Semgrep version to avoid floating latest tag
      image: returntocorp/semgrep:1.67.0
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Validate Semgrep configuration
        run: |
          echo "ğŸ” Validating Semgrep setup..."
          if [ -z "$SEMGREP_APP_TOKEN" ]; then
            echo "âŒ SEMGREP_APP_TOKEN not set"
            exit 1
          fi
          echo "âœ… Semgrep token configured"

      - name: Run Semgrep Security Scan
        id: semgrep
        run: |
          echo "ğŸ”’ Running Semgrep security scan..."
          # Mask sensitive data in logs
          echo "::add-mask::${{ secrets.SEMGREP_APP_TOKEN }}"
          # Output both JSON (artifact) and SARIF (code scanning)
          semgrep ci --config auto --json --sarif --output semgrep-results.sarif > semgrep-results.json || {
            echo "âŒ Semgrep scan found issues - review results above"
            exit 1
          }
          echo "âœ… Semgrep scan completed successfully"
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Process Scan Results
        id: process
        run: |
          echo "ğŸ“Š Processing scan results..."
          if [ -f semgrep-results.json ]; then
            findings=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
            echo "findings=$findings" >> $GITHUB_OUTPUT
            echo "ğŸ“ˆ Found $findings security findings"
          else
            echo "findings=0" >> $GITHUB_OUTPUT
            echo "âš ï¸ No results file generated"
          fi

      - name: Upload SARIF Results to GitHub Security Tab
        if: always()
        uses: github/codeql-action/upload-sarif@e2b3eafc8d227b0241d48be5f425d47c2d750a13 # v3.26.10
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep
        continue-on-error: true

      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: semgrep-scan-results
          path: |
            semgrep-results.json
            semgrep-results.sarif
          retention-days: 30

      - name: Comment on PR with Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const findings = ${{ steps.process.outputs.findings || 0 }};
            const status = findings > 0 ? 'âŒ' : 'âœ…';
            const message = findings > 0
              ? `**Semgrep Security Scan Failed** - Found ${findings} potential security issues that need review.`
              : '**Semgrep Security Scan Passed** - No critical security issues detected.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${status} ${message}\n\nğŸ” [View detailed results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });

      - name: Fail on High Severity Findings
        if: steps.process.outputs.findings > 0
        run: |
          echo "âŒ Security scan found ${findings} issues"
          echo "ğŸ“‹ Review the scan results above and fix critical findings"
          exit 1
