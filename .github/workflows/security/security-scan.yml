name: Security Scan

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@cb7149a9idfd2e0706f8d9b2f3b5e18bb83e4f3d # v2.3.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Semgrep
        uses: returntocorp/semgrep-action@713efdd345f3035192eaa63f56867b88e63e4e5d # v1.95.0
        with:
          config: ".semgrep.yml"
        env:
          SEMGREP_RULES: ".semgrep.yml"

      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@e2b3eafc8d227b0241d48be5f425d47c2d750a13 # v3.26.10
        with:
          sarif_file: semgrep.sarif
          category: semgrep

      - name: Initialize CodeQL (optional)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: github/codeql-action/init@e2b3eafc8d227b0241d48be5f425d47c2d750a13 # v3.26.10
        with:
          languages: "javascript"

      - name: Analyze CodeQL (optional)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: github/codeql-action/analyze@e2b3eafc8d227b0241d48be5f425d47c2d750a13 # v3.26.10

  workflow-security:
    name: Validate Workflow Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Run workflow security validator
        run: |
          bash scripts/validate-workflows.sh

      - name: Install actionlint
        run: |
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          sudo mv actionlint /usr/local/bin/

      - name: Run actionlint
        run: |
          actionlint -color -verbose

      - name: Check for hardcoded secrets in workflows
        run: |
          echo "ðŸ” Scanning workflows for potential hardcoded secrets..."

          ISSUES=0
          # Check for common secret patterns (case-insensitive)
          if find .github/workflows .github/actions libs/ci -type f \( -name "*.yml" -o -name "*.yaml" \) -exec \
            grep -iE '(password|secret|token|api[_-]?key|access[_-]?key|private[_-]?key)(\s*[:=]\s*["\x27][^\x27"]+["\x27])' {} + 2>/dev/null | \
            grep -v 'secrets\.' | grep -v 'inputs\.' | grep -v 'env\.' | grep -v '#'; then
            echo "âŒ Potential hardcoded secrets found!"
            echo "Please use GitHub Secrets or environment variables instead."
            ((ISSUES++))
          fi

          if [[ $ISSUES -gt 0 ]]; then
            exit 1
          else
            echo "âœ… No hardcoded secrets detected"
          fi

      - name: Verify security best practices
        run: |
          echo "ðŸ” Checking workflow best practices..."

          WARNINGS=0

          # Check for unpinned action versions
          echo "Checking for unpinned action versions..."
          if find .github/workflows .github/actions libs/ci -type f \( -name "*.yml" -o -name "*.yaml" \) -exec \
             grep -h "uses:" {} + | \
             grep -v "@" | \
             grep -v "\./" | \
             grep "actions/\|github/" | head -5; then
            echo "âš ï¸  Found unpinned action versions (should use @commit-sha or @vX.Y.Z)"
            ((WARNINGS++))
          fi

          # Check for pull_request_target usage (security risk)
          echo ""
          echo "Checking for pull_request_target trigger..."
          if find .github/workflows -type f \( -name "*.yml" -o -name "*.yaml" \) -exec \
             grep -l "pull_request_target:" {} + 2>/dev/null; then
            echo "âš ï¸  Found pull_request_target trigger - ensure untrusted code doesn't run with secrets"
            ((WARNINGS++))
          fi

          echo ""
          if [[ $WARNINGS -gt 0 ]]; then
            echo "âš ï¸  Found $WARNINGS potential security issues (warnings only)"
            echo "Please review the above findings."
          else
            echo "âœ… All security best practices checks passed"
          fi

      - name: Generate workflow security summary
        if: always()
        run: |
          echo "## ðŸ”’ Workflow Security Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Checks Performed:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Shell injection vulnerability scan" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Workflow syntax validation (actionlint)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Hardcoded secrets detection" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security best practices audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Guidelines:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Never use \`\${{ ... }}\` directly in \`run:\` steps" >> $GITHUB_STEP_SUMMARY
          echo "2. Always use \`env:\` blocks for GitHub context variables" >> $GITHUB_STEP_SUMMARY
          echo "3. Quote all environment variables: \`\"\${VAR}\"\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Pin action versions to commit SHAs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See: [GitHub Actions Security Hardening](https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions)" >> $GITHUB_STEP_SUMMARY
